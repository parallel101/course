---
theme: seriph
background: images/bg.png
class: text-center
highlighter: shiki
lineNumbers: true
info: |
  ## Archibate's STL course series
  Presentation slides for archibate.

  Learn more at [parallel101/course](https://github.com/parallel101/course)
drawings:
  persist: false
transition: none
css: unocss
---

# å°å½­è€å¸ˆ STL è¯¾ç¨‹ç³»åˆ— ä¹‹ map

è®©é«˜æ€§èƒ½æ•°æ®ç»“æ„æƒ åŠæ¯ä¸€äºº

---

# è¯¾ç¨‹ç®€ä»‹

ğŸ˜€ğŸ˜€ğŸ˜€

é¢å‘å­¦ä¹  C++ æ ‡å‡†åº“çš„ç«¥é‹ã€‚

ä¸»è¦å­¦ä¹  STL å®¹å™¨ã€‚

ä¸»è¦åŸºäº C++17 è¯­è¨€æ ‡å‡†ã€‚

---

# è¯¾ç¨‹å¤§çº²

âœ¨âœ¨âœ¨

ä¹‹å‰å‡ æœŸè¯¾ç¨‹çš„å½•æ’­å·²ç»ä¸Šä¼ åˆ°æ¯”ç«™äº†[^1]ã€‚

1. vector å®¹å™¨åˆä½“éªŒ & è¿­ä»£å™¨å…¥é—¨ (BV1qF411T7sd)
2. ä½ æ‰€ä¸çŸ¥é“çš„ set å®¹å™¨ & è¿­ä»£å™¨åˆ†ç±» (BV1m34y157wb)
3. stringï¼Œstring_viewï¼Œconst char * çš„çˆ±æ¨çº è‘› (BV1ja411M7Di) 
4. ä¸‡èƒ½çš„ map å®¹å™¨å…¨å®¶æ¡¶åŠå…¶å¦™ç”¨ä¸¾ä¾‹ (æœ¬æœŸ)
5. å‡½å­ functor ä¸ lambda è¡¨è¾¾å¼çŸ¥å¤šå°‘
6. é€šè¿‡å®æˆ˜æ¡ˆä¾‹æ¥å­¦ä¹  STL ç®—æ³•åº“
7. C++ æ ‡å‡†è¾“å…¥è¾“å‡ºæµ & å­—ç¬¦ä¸²æ ¼å¼åŒ–
8. traits æŠ€æœ¯ï¼Œç”¨æˆ·è‡ªå®šä¹‰è¿­ä»£å™¨ä¸ç®—æ³•
9. allocatorï¼Œå†…å­˜ç®¡ç†ä¸å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ
10. C++ å¼‚å¸¸å¤„ç†æœºåˆ¶çš„å‰ä¸–ä»Šç”Ÿ

[^1]: https://space.bilibili.com/263032155

---

# è¯¾ç¨‹è¦æ±‚

âœ…âœ…âœ…

è¯¾ä»¶ä¸­æ‰€ç¤ºä»£ç å®éªŒæ¨èç¯å¢ƒå¦‚ä¸‹ï¼š

| è¦æ±‚     | â¤â¤â¤        | ğŸ’£ğŸ’£ğŸ’£       | ğŸ’©ğŸ’©ğŸ’©         |
|----------|------------|--------------|----------------|
| æ“ä½œç³»ç»Ÿ | Arch Linux | Ubuntu 20.04 | Wendous 10     |
| çŸ¥è¯†å‚¨å¤‡ | ä¼šä¸€ç‚¹ C++ | å¤§å­¦ C è¯­è¨€  | Java é¢å‘å¯¹è±¡  |
| ç¼–è¯‘å™¨   | GCC 9 ä»¥ä¸Š | Clang 12     | VS 2019        |
| æ„å»ºç³»ç»Ÿ | CMake 3.18 | ä»»æ„ C++ IDE | å‘½ä»¤è¡Œæ‰‹åŠ¨ç¼–è¯‘ |

â¤ = æ¨èï¼ŒğŸ’£ = å¯ç”¨ï¼ŒğŸ’© = å›°éš¾

---

# å¦‚ä½•ä½¿ç”¨è¯¾ä»¶

ğŸ¥°ğŸ¥°ğŸ¥°

æœ¬ç³»åˆ—è¯¾ä»¶å’Œæºç å‡å…¬å¸ƒåœ¨ï¼šhttps://github.com/parallel101/course

ä¾‹å¦‚æœ¬æœŸçš„è¯¾ä»¶ä½äº `course/stlseries/stl_map/slides.md`ã€‚

è¯¾ä»¶åŸºäº Slidev[^1] å¼€å‘ï¼ŒMarkdown æ ¼å¼ä¹¦å†™ï¼Œåœ¨æµè§ˆå™¨ä¸­æ˜¾ç¤ºï¼Œåœ¨æœ¬åœ°è¿è¡Œè¯¾ä»¶éœ€è¦ Node.jsï¼š

- è¿è¡Œå‘½ä»¤ `npm install` å³å¯è‡ªåŠ¨å®‰è£… Slidev
- è¿è¡Œå‘½ä»¤ `npm run dev` å³å¯è¿è¡Œ Slidev æœåŠ¡
- è®¿é—® http://localhost:3030 å³å¯çœ‹åˆ°è¯¾ä»¶

å¦‚æœæŠ¥é”™æ‰¾ä¸åˆ° `slidev` å‘½ä»¤ï¼Œè¯•è¯•çœ‹ `export PATH="$PWD/node_modules/.bin:$PATH"`ã€‚

å¦‚æœä¸æƒ³è‡ªå·±é…ç½® Node.js ä¹Ÿå¯ä»¥ç›´æ¥ä»¥æ–‡æœ¬æ–‡ä»¶æ ¼å¼æ‰“å¼€ slides.md æµè§ˆè¯¾ä»¶ã€‚

Slidev æœåŠ¡è¿è¡Œä¸­å¯¹ slides.md çš„ä¿®æ”¹ä¼šç«‹åˆ»å®æ—¶æ˜¾ç°åœ¨æµè§ˆå™¨ä¸­ã€‚

[^1]: https://sli.dev/

---

# å¦‚ä½•è¿è¡Œæ¡ˆä¾‹ä»£ç 

ğŸ¥ºğŸ¥ºğŸ¥º

CMake å·¥ç¨‹ä½äºè¯¾ä»¶åŒç›®å½•çš„ `course/stlseries/stl_map/experiment/` æ–‡ä»¶å¤¹ä¸‹ã€‚

å…¶ä¸­ main.cpp ä»…å¯¼å…¥è¿è¡Œæ¡ˆä¾‹æ‰€éœ€çš„å¤´æ–‡ä»¶ï¼Œå…·ä½“å„ä¸ªæ¡ˆä¾‹ä»£ç åˆ†å¸ƒåœ¨ slides.md é‡Œã€‚

å¦‚éœ€æµ‹è¯•å…·ä½“ä»£ç ï¼Œå¯ä»¥æŠŠ slides.md ä¸­çš„æ¡ˆä¾‹ä»£ç ç²˜è´´åˆ° main.cpp çš„ main å‡½æ•°ä½“ä¸­è¿›è¡Œå®éªŒã€‚

é™„èµ çš„ä¸€äº›å®ç”¨å¤´æ–‡ä»¶ï¼ŒåŒé‹ä»¬å¯ä»¥è‡ªå·±çš„é¡¹ç›®é‡Œéšæ„è¿ç”¨ã€‚

| æ–‡ä»¶å | åŠŸèƒ½ |
|-|-|
| main.cpp | æŠŠ slides.md ä¸­ä½ æƒ³è¦å®éªŒçš„ä»£ç ç²˜è´´åˆ° main å‡½æ•°ä¸­ |
| print.h | å†…å« print å‡½æ•°ï¼Œæ”¯æŒæ‰“å°ç»å¤§å¤šæ•° STL å®¹å™¨ï¼Œæ–¹ä¾¿è°ƒè¯• |
| cppdemangle.h | è·å¾—ç±»å‹çš„åå­—ï¼Œä»¥æ¨¡æ¿ä¼ å…¥ï¼Œè¯¦è§è¯¥æ–‡ä»¶ä¸­çš„ Usage ä»‹ç» |
| map_get.h | å¸¦é»˜è®¤å€¼çš„ map è¡¨é¡¹æŸ¥è¯¢ï¼Œç¨åè¯¾ç¨‹ä¸­ä¼šä»‹ç»åˆ° |

---

åˆ›å»ºä¸€ä¸ª map å¯¹è±¡ï¼š

```cpp
map<string, int> config;
```

ä¸€å¼€å§‹ map é»˜è®¤æ˜¯ç©ºçš„ï¼Œå¦‚ä½•æ’å…¥ä¸€äº›åˆå§‹æ•°æ®ï¼Ÿ

```cpp
config["timeout"] = 985;
config["delay"] = 211;
```

---

C++11 æ–°ç‰¹æ€§â€”â€”èŠ±æ‹¬å·åˆå§‹åŒ–åˆ—è¡¨ï¼Œå…è®¸åˆ›å»º map æ—¶ç›´æ¥æŒ‡å®šåˆå§‹æ•°æ®ï¼š

```cpp
map<string, int> config = { {"timeout", 985}, {"delay", 211} };
```

é€šå¸¸ä¼šæ¢è¡Œå†™ï¼Œä¸€è¡Œä¸€ä¸ªé”®å€¼å¯¹ï¼Œçœ‹èµ·æ¥æ¡ç†æ›´æ¸…æ™°ï¼š

```cpp
map<string, int> config = {
    {"timeout", 985},
    {"delay", 211},
};
```

æ€»ç»“ï¼š

```cpp
map<K, V> m = {
    {k1, v1},
    {k2, v2},
    ...,
};
```

---

```cpp
map<string, int> config = {
    {"timeout", 985},
    {"delay", 211},
};
```

ç­‰å·å¯ä»¥çœç•¥ï¼ˆè¿™å…¶å®å°±æ˜¯ map çš„æ„é€ å‡½æ•°ï¼‰ï¼š

```cpp
map<string, int> config{
    {"timeout", 985},
    {"delay", 211},
};
```

ä¹Ÿå¯ä»¥å…ˆæ„é€ å†èµ‹å€¼ç»™ auto å˜é‡ï¼š

```cpp
auto config = map<string, int>{
    {"timeout", 985},
    {"delay", 211},
};
```

éƒ½æ˜¯ç­‰ä»·çš„ã€‚

---

ä½œä¸ºå‡½æ•°å‚æ•°æ—¶ï¼Œå¯ä»¥ç”¨èŠ±æ‹¬å·åˆå§‹åŒ–åˆ—è¡¨å°±åœ°æ„é€ ä¸€ä¸ª map å¯¹è±¡ï¼š

```cpp
void myfunc(map<string, int> config);

myfunc(map<string, int>{
    {"timeout", 985},
    {"delay", 211},
});
```

ç”±äº `myfunc` å‡½æ•°å…·æœ‰å”¯ä¸€ç¡®å®šçš„é‡è½½ï¼Œè¦æ„é€ çš„å‚æ•°ç±»å‹ `map<string, int>` å¯ä»¥çœç•¥ä¸å†™ï¼š

```cpp
myfunc({
    {"timeout", 985},
    {"delay", 211},
});
```

å‡½æ•°è¿™è¾¹ï¼Œé€šå¸¸è¿˜ä¼šåŠ ä¸Š `const &` ä¿®é¥°é¿å…ä¸å¿…è¦çš„æ‹·è´ã€‚

```cpp
void myfunc(map<string, int> const &config);
```

---

å¦‚ä½•æ ¹æ®é”®æŸ¥è¯¢ç›¸åº”çš„å€¼ï¼Ÿ

å¾ˆå¤šåŒå­¦éƒ½çŸ¥é“ map å…·æœ‰ [] è¿ç®—ç¬¦é‡è½½ï¼Œå’Œä¸€äº›è„šæœ¬è¯­è¨€ä¸€æ ·ï¼Œç›´è§‚æ˜“æ‡‚ã€‚

```cpp
config["timeout"] = 985;       // æŠŠ config ä¸­é”® timeout å¯¹åº”å€¼è®¾ä¸º 985
auto val = config["timeout"];  // è¯»å– config ä¸­é”® timeout å¯¹åº”å€¼
print(val);                    // 985
```

ä½†å…¶å®ç”¨ [] è®¿é—®å…ƒç´ æ˜¯å¾ˆä¸å®‰å…¨çš„ï¼Œä¸‹é¢æˆ‘ä¼šåšå®éªŒæ¼”ç¤ºè¿™ä¸€ç‚¹ã€‚

---

æ²‰é»˜çš„ []ï¼Œæ— è¨€çš„å±é™©ï¼šå½“é”®ä¸å­˜åœ¨æ—¶ï¼Œä¼šè¿”å› 0 è€Œä¸ä¼šå‡ºé”™ï¼

```cpp
map<string, int> config = {
    {"timeout", 985},
    {"delay", 211},
};
print(config["timeout"]); // 985
print(config["tmeout"]);  // é»˜é»˜è¿”å› 0
```

```
985
0
```

å½“æŸ¥è¯¢çš„é”®å€¼ä¸å­˜åœ¨æ—¶ï¼Œ[] ä¼šé»˜é»˜åˆ›å»ºå¹¶è¿”å› 0ã€‚

è¿™éå¸¸å±é™©ï¼Œä¾‹å¦‚ä¸€ä¸ªç®€ç®€å•å•çš„æ‹¼å†™é”™è¯¯ï¼Œå°±ä¼šå¯¼è‡´ map çš„æŸ¥è¯¢é»˜é»˜è¿”å› 0ï¼Œä½ è¿˜åœ¨é‚£é‡Œæ‰¾äº†åŠå¤©æ‘¸ä¸ç€å¤´è„‘ï¼Œæ ¹æœ¬æ²¡å‘ç°é”™è¯¯åŸæ¥åœ¨ map è¿™é‡Œã€‚

---

çˆ±å“­çˆ±é—¹çš„ at()ï¼Œåè€Œæ›´è®¨äººå–œæ¬¢

```cpp
map<string, int> config = {
    {"timeout", 985},
    {"delay", 211},
};
print(config.at("timeout"));  // 985
print(config.at("tmeout"));   // è¯¥é”®ä¸å­˜åœ¨ï¼å“äº®åœ°å‡ºé”™
```

```
985
terminate called after throwing an instance of 'std::out_of_range'
  what():  map::at
Aborted (core dumped)
```

æœ‰ç»éªŒçš„è€æ‰‹éƒ½æ˜ç™½ä¸€ä¸ªé“ç†ï¼š**åŠæ—¶å¥”æºƒ**æ¯”**å®¹å¿é”™è¯¯**æ›´æœ‰åˆ©äºè°ƒè¯•ã€‚å³ fail-early, fail-loudly[^1] åŸåˆ™ã€‚

ä¾‹å¦‚ JS å’Œ Lua çš„ [] è®¿é—®è¶Šç•Œä¸æŠ¥é”™è€Œæ˜¯è¿”å› undefined / nilï¼Œå¯¼è‡´å®é™…å‡ºé”™çš„ä½ç½®åœ¨å¥½å‡ åè¡Œä¹‹åï¼Œæ— æ³•å®šä½åˆ°çœŸæ­£å‡ºé”™çš„ä½ç½®ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåæ¥å‘æ˜äº†é”™è¯¯æ£€æŸ¥æ›´ä¸¥æ ¼çš„ TSã€‚

ä½¿ç”¨ at() å¯ä»¥å¸®åŠ©ä½ æ›´å®¹æ˜“å®šä½åˆ°é”™è¯¯ï¼Œæ˜¯å¥½äº‹ã€‚

[^1]: https://oncodingstyle.blogspot.com/2008/10/fail-early-fail-loudly.html

---

[] æ›´å±é™©çš„åœ°æ–¹åœ¨äºï¼Œå½“æ‰€æŸ¥è¯¢çš„é”®å€¼ä¸å­˜åœ¨æ—¶ï¼š

```cpp
map<string, int> config = {
    {"timeout", 985},
    {"delay", 211},
};
print(config);
print(config["tmeout"]);  // æœ‰å‰¯ä½œç”¨ï¼
print(config);
```

```
{"delay": 211, "timeout": 985}
0
{"delay": 211, "timeout": 985, "tmeout": 0}
```

ä¼šè‡ªåŠ¨åˆ›å»ºé‚£ä¸ªä¸å­˜åœ¨çš„é”®å€¼ï¼

ä½ ä»¥ä¸ºä½ åªæ˜¯è§‚å¯Ÿäº†ä¸€ä¸‹ map é‡Œçš„ "tmeout" å…ƒç´ ï¼Œå´æ„å¤–æ”¹å˜äº† map çš„å†…å®¹ï¼Œè–›å®šè°”[^1]ç›´å‘¼å†…è¡Œã€‚

[^1]: https://baike.baidu.com/item/%E8%96%9B%E5%AE%9A%E8%B0%94%E7%9A%84%E7%8C%AB/554903

---

[] è¿™ä¸ªæˆå‘˜å‡½æ•°æ²¡æœ‰ const ä¿®é¥°ï¼Œå› æ­¤å½“ map ä¿®é¥°ä¸º const æ—¶ç¼–è¯‘ä¼šä¸é€šè¿‡[^1]ï¼š

```cpp
const map<string, int> config = {
    {"timeout", 985},
    {"delay", 211},
};
print(config["timeout"]);  // ç¼–è¯‘å‡ºé”™
```

```
/home/bate/Codes/course/stlseries/stl_map/experiment/main.cpp: In function â€˜int main()â€™:
/home/bate/Codes/course/stlseries/stl_map/experiment/main.cpp:10:23: error: passing â€˜const
std::map<std::__cxx11::basic_string<char>, int>â€™ as â€˜thisâ€™ argument discards qualifiers
[-fpermissive]
   10 | print(config["timeout"]);
```

ç¼–è¯‘å™¨è¯´ discards qualifiersï¼Œæ„æ€æ˜¯ map æœ‰ const ä¿®é¥°ï¼Œä½†æ˜¯ map::operator[] æ²¡æœ‰ã€‚

æŠŠæœ‰ const ä¿®é¥°çš„ map ä½œä¸º this æŒ‡é’ˆä¼ å…¥æ²¡æœ‰ const ä¿®é¥°çš„ map::operator[] å‡½æ•°ï¼Œæ˜¯å‡å°‘äº†ä¿®é¥°ï¼ˆdiscards qualifersï¼‰ã€‚C++ è§„å®šä¼ å‚æ—¶åªèƒ½å¢åŠ ä¿®é¥°ä¸èƒ½å‡å°‘ä¿®é¥°ï¼šåªèƒ½ä» map &amp; è½¬æ¢åˆ° const map &amp; è€Œä¸èƒ½åä¹‹ï¼Œæ‰€ä»¥å¯¹ç€ä¸€ä¸ª const map è°ƒç”¨é const çš„æˆå‘˜å‡½æ•°å°±å‡ºé”™äº†ã€‚

ç›¸æ¯”ä¹‹ä¸‹ at() å°±å¯ä»¥åœ¨ const ä¿®é¥°ä¸‹ç¼–è¯‘é€šè¿‡ï¼Œå¯è§ at() æ‰æ˜¯è¯»å–å…ƒç´ çš„æ­£é“ã€‚

[^1]: https://blog.csdn.net/benobug/article/details/104903314

---

æ—¢ç„¶ [] è¿™ä¹ˆå±é™©ï¼Œä¸ºä»€ä¹ˆè¿˜è¦å­˜åœ¨å‘¢ï¼Ÿ

```cpp
map<string, int> config = {
    {"delay", 211},
};
config.at("timeout") = 985;  // é”®å€¼ä¸å­˜åœ¨ï¼ŒæŠ¥é”™ï¼
config["timeout"] = 985;     // æˆåŠŸåˆ›å»ºå¹¶å†™å…¥ 985
```

å› ä¸ºå½“æˆ‘ä»¬å†™å…¥ä¸€ä¸ªæœ¬ä¸å­˜åœ¨çš„é”®å€¼çš„æ—¶å€™ï¼Œæ°æ°éœ€è¦ä»–çš„â€œè‡ªåŠ¨åˆ›å»ºâ€è¿™ä¸€ç‰¹æ€§ã€‚

æ€»ç»“ï¼šè¯»å–æ—¶åº”è¯¥ç”¨ at() æ›´å®‰å…¨ï¼Œå†™å…¥æ—¶æ‰éœ€è¦ []ã€‚

---

å› æ­¤ï¼Œæˆ‘çš„å»ºè®®æ˜¯ï¼š

- è¯»å–å…ƒç´ æ—¶ï¼Œç»Ÿä¸€ç”¨ at()
- å†™å…¥å…ƒç´ æ—¶ï¼Œç»Ÿä¸€ç”¨ []

```cpp
auto val = m.at("key");
m["key"] = val;
```

ä¸è¦ç”¨æ··äº†å“¦ï¼

ä¸ºä»€ä¹ˆå…¶ä»–è¯­è¨€æ¯”å¦‚ Pythonï¼Œåªæœ‰ä¸€ä¸ª [] å°±è¡Œäº†å‘¢ï¼Ÿè€Œ C++ éœ€è¦ä¸¤ä¸ªï¼Ÿ

- å› ä¸º Python ä¼šæ£€æµ‹ [] ä½äºç­‰å·å·¦ä¾§è¿˜æ˜¯å³ä¾§ï¼Œæ ¹æ®æƒ…å†µåˆ†åˆ«è°ƒç”¨ `__getitem__` æˆ–è€… `__setitem__`ã€‚
- C++ ç¼–è¯‘å™¨æ²¡æœ‰è¿™ä¸ªç‰¹æ®Šæ£€æµ‹ï¼ŒC++ çš„ [] åªæ˜¯è¿”å›äº†ä¸ªå¼•ç”¨ï¼Œå¹¶ä¸çŸ¥é“ [] å‡½æ•°è¿”å›ä»¥åï¼Œä½ æ˜¯æ‹¿è¿™ä¸ªå¼•ç”¨å†™å…¥è¿˜æ˜¯è¯»å–ã€‚ä¸ºäº†ä¿é™©èµ·è§ä»–é»˜è®¤ä½ æ˜¯å†™å…¥ï¼Œæ‰€ä»¥å…ˆå¸®ä½ åˆ›å»ºäº†å…ƒç´ ï¼Œè¿”å›è¿™ä¸ªå…ƒç´ çš„å¼•ç”¨ï¼Œè®©ä½ å†™å…¥ã€‚
- è€Œ Python çš„å¼•ç”¨æ˜¯ä¸èƒ½ç”¨ = è¦†ç›–åŸå€¼çš„ï¼Œé‚£æ ·åªä¼šè®©å˜é‡æŒ‡å‘æ–°çš„å¼•ç”¨ï¼Œåªèƒ½ç”¨ .func() å¼•ç”¨æˆå‘˜å‡½æ•°æˆ–è€… += æ‰èƒ½å°±åœ°ä¿®æ”¹åŸå˜é‡ï¼Œè¿™æ˜¯ Python è¿™ç±»è„šæœ¬è¯­è¨€å’Œ C++ æœ€æœ¬è´¨çš„ä¸åŒã€‚
- æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬ç”¨ C++ çš„ map è¯»å–å…ƒç´ æ—¶ï¼Œéœ€è¦æ˜¾å¼åœ°ç”¨ at() å‘Šè¯‰ç¼–è¯‘å™¨æˆ‘æ˜¯æ‰“ç®—è¯»å–ã€‚

---

[] ä¹Ÿæœ‰å…¶ä»–çš„æ„ä¹‰

é™¤äº†å†™å…¥å…ƒç´ éœ€è¦ç”¨ [] ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€äº›æ¡ˆä¾‹ä¸­åˆç†è¿ç”¨ [] ä¼šéå¸¸çš„æ–¹ä¾¿ã€‚

[] çš„æ•ˆæœï¼šå½“æ‰€æŸ¥è¯¢çš„é”®å€¼ä¸å­˜åœ¨æ—¶ï¼Œä¼šè°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°åˆ›å»ºä¸€ä¸ªå…ƒç´ ã€‚

- å¯¹äº int, float ç­‰æ•°å€¼ç±»å‹è€Œè¨€ï¼Œé»˜è®¤å€¼æ˜¯ 0ã€‚
- å¯¹äºæŒ‡é’ˆï¼ˆåŒ…æ‹¬æ™ºèƒ½æŒ‡é’ˆï¼‰è€Œè¨€ï¼Œé»˜è®¤å€¼æ˜¯ nullptrã€‚
- å¯¹äº string è€Œè¨€ï¼Œé»˜è®¤å€¼æ˜¯ç©ºå­—ç¬¦ä¸² ""ã€‚
- å¯¹äº vector è€Œè¨€ï¼Œé»˜è®¤å€¼æ˜¯ç©ºæ•°ç»„ {}ã€‚
- å¯¹äºè‡ªå®šä¹‰ç±»è€Œè¨€ï¼Œè°ƒç”¨ä½ å†™çš„é»˜è®¤æ„é€ å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æ¯ä¸ªæˆå‘˜éƒ½å–é»˜è®¤å€¼ã€‚

---

[] è¿ç”¨ä¸¾ä¾‹ï¼šå‡ºç°æ¬¡æ•°ç»Ÿè®¡

```cpp
vector<string> input = {"hello", "world", "hello"};
map<string, int> counter;
for (auto const &key: input) {
    counter[key]++;
}
print(counter);
```

```
{"hello": 2, "world": 1}
```

---
layout: two-cols-header
---

::left::

<center>

æ´»ç”¨ [] è‡ªåŠ¨åˆ›å»º 0 å…ƒç´ çš„ç‰¹æ€§

</center>

```cpp {3}
map<string, int> counter;
for (auto const &key: input) {
    counter[key]++;
}
```

::right::

<center>

å¤æ¿çš„å†™æ³•

</center>

```cpp {3-7}
map<string, int> counter;
for (auto const &key: input) {
    if (!counter.count(key)) {
        counter[key] = 1;
    } else {
        counter[key] = counter.at(key) + 1;
    }
}
```

---

[] è¿ç”¨ä¸¾ä¾‹ï¼šå½’ç±»

```cpp
vector<string> input = {"happy", "world", "hello", "weak", "strong"};
map<char, vector<string>> categories;
for (auto const &str: input) {
    char key = str[0];
    categories[key].push_back(str);
}
print(categories);
```

```
{'h': {"happy", "hello"}, 'w': {"world", "weak"}, 's': {"strong"}}
```

---
layout: two-cols-header
---

::left::

<center>

æ´»ç”¨ [] è‡ªåŠ¨åˆ›å»º"é»˜è®¤å€¼"å…ƒç´ çš„ç‰¹æ€§

</center>

```cpp {4}
map<char, vector<string>> categories;
for (auto const &str: input) {
    char key = str[0];
    categories[key].push_back(str);
}
print(categories);
```

::right::

<center>

å¤æ¿çš„å†™æ³•

</center>

```cpp {4-8}
map<char, vector<string>> categories;
for (auto const &str: input) {
    char key = str[0];
    if (!categories.count(key)) {
        categories[key] = {str};
    } else {
        categories[key].push_back(str);
    }
}
```

---
layout: center
---

![Elegence](https://pica.zhimg.com/50/v2-f2560f634b1e09f81522f29f363827f7_720w.jpg)

---

STL å®¹å™¨çš„å…ƒç´ ç±»å‹éƒ½å¯ä»¥é€šè¿‡æˆå‘˜ `value_type` æŸ¥è¯¢ï¼Œå¸¸ç”¨äºæ³›å‹ç¼–ç¨‹ï¼ˆåˆç§°å…ƒç¼–ç¨‹ï¼‰ã€‚

```cpp
set<int>::value_type      // int
vector<int>::value_type   // int
string::value_type        // char
```

åœ¨æœ¬è¯¾ç¨‹çš„æ¡ˆä¾‹ä»£ç ä¸­ï¼Œé™„èµ ä¸€ä»½ "cppdemangle.h"ï¼Œå¯ä»¥å®ç°æ ¹æ®æŒ‡å®šçš„ç±»å‹æŸ¥è¯¢ç±»å‹åç§°å¹¶æ‰“å°å‡ºæ¥ã€‚

è·¨å¹³å°ï¼Œæ”¯æŒ MSVCï¼ŒClangï¼ŒGCC ä¸‰å¤§ç¼–è¯‘å™¨ï¼Œä¾‹å¦‚ï¼š

```cpp
int i;
print(cppdemangle<decltype(std::move(i))>());
print(cppdemangle<std::string>());
print(cppdemangle<std::wstring::value_type>());
```

åœ¨æˆ‘çš„ GCC 12.2.1 ä¸Šå¾—åˆ°ï¼š

```
"int &&"
"std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >"
"wchar_t"
```

---

é—®é¢˜: map çœŸæ­£çš„å…ƒç´ ç±»å‹ç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Ÿå…¶å…·æœ‰ä¸‰ä¸ªæˆå‘˜ç±»å‹[^1]ï¼š

- å…ƒç´ ç±»å‹ï¼š`value_type`
- é”®ç±»å‹ï¼š`key_type`
- å€¼ç±»å‹ï¼š`mapped_type`

ç”¨ cppdemangle åšå®éªŒï¼Œçœ‹çœ‹è¿™äº›æˆå‘˜ç±»å‹å…·ä½“æ˜¯ä»€ä¹ˆå§ï¼š

```cpp
map<int, float>::value_type   // pair<const int, float>
map<int, float>::key_type     // int
map<int, float>::mapped_type  // float
```

ç»“è®ºï¼š`map<K, V>` çš„å…ƒç´ ç±»å‹æ˜¯ `pair<const K, V>` è€Œä¸æ˜¯ `V`ã€‚

[^1]: https://blog.csdn.net/janeqi1987/article/details/100049597

---

`pair<const K, V>` â€”â€”ä¸ºä»€ä¹ˆ K è¦åŠ  constï¼Ÿ

ä¸ŠæœŸ set è¯¾è¯´è¿‡ï¼Œset å†…éƒ¨é‡‡ç”¨çº¢é»‘æ ‘æ•°æ®ç»“æ„ä¿æŒæœ‰åºï¼Œè¿™æ ·æ‰èƒ½å®ç°åœ¨ $O(\log N)$ æ—¶é—´å†…é«˜æ•ˆæŸ¥æ‰¾ã€‚

é”®å€¼æ”¹å˜çš„è¯ä¼šéœ€è¦é‡æ–°æ’åºï¼Œå¦‚æœåªä¿®æ”¹é”®å€¼è€Œä¸é‡æ–°æ’åºï¼Œä¼šç ´åæœ‰åºæ€§ï¼Œå¯¼è‡´äºŒåˆ†æŸ¥æ‰¾ç»“æœé”™è¯¯ï¼
æ‰€ä»¥ set åªæœ‰ä¸å¯å˜è¿­ä»£å™¨ï¼ˆconst_iteratorï¼‰ï¼Œä¸å…è®¸ä¿®æ”¹å…ƒç´ çš„å€¼ã€‚

map å’Œ set ä¸€æ ·ä¹Ÿæ˜¯çº¢é»‘æ ‘ï¼Œä¸åŒåœ¨äºï¼šmap åªæœ‰é”® K çš„éƒ¨åˆ†ä¼šå‚ä¸æ’åºï¼ŒV æ˜¯ä¸ªæ—è§‚è€…ï¼Œéšä¾¿ä¿®æ”¹ä¹Ÿæ²¡å…³ç³»ã€‚

æ‰€ä»¥ map æœ‰å¯å˜è¿­ä»£å™¨ï¼Œåªæ˜¯åœ¨å…¶ value_type ä¸­ç»™ K åŠ ä¸Šäº† const ä¿®é¥°ï¼šä¸å…è®¸ä¿®æ”¹ Kï¼Œä½†å¯ä»¥ä¿®æ”¹ Vã€‚

å¦‚æœä½ ç¡®å®éœ€è¦ä¿®æ”¹é”®å€¼ï¼Œé‚£ä¹ˆè¯·å…ˆæŠŠè¿™ä¸ªé”®åˆ äº†ï¼Œç„¶åå†ä»¥åŒæ ·çš„ V é‡æ–°æ’å…¥ä¸€éï¼Œä¿è¯çº¢é»‘æ ‘çš„æœ‰åºã€‚

---

```cpp
iterator find(K const &k);
const_iterator find(K const &k) const;
```

m.find(key) å‡½æ•°ï¼Œæ ¹æ®æŒ‡å®šçš„é”® key æŸ¥æ‰¾å…ƒç´ [^1]ã€‚

- æˆåŠŸæ‰¾åˆ°ï¼Œåˆ™è¿”å›æŒ‡å‘æ‰¾åˆ°å…ƒç´ çš„è¿­ä»£å™¨
- æ‰¾ä¸åˆ°ï¼Œåˆ™è¿”å› m.end()

ç¬¬äºŒä¸ªç‰ˆæœ¬çš„åŸå‹ä½œç”¨æ˜¯ï¼šå¦‚æœ map æœ¬èº«æœ‰ const ä¿®é¥°ï¼Œåˆ™è¿”å›çš„ä¹Ÿæ˜¯ const è¿­ä»£å™¨ã€‚

[^1]: https://en.cppreference.com/w/cpp/container/map/find

---

æ£€æŸ¥è¿‡ä¸æ˜¯ m.end()ï¼Œä»¥ç¡®è®¤æˆåŠŸæ‰¾åˆ°åï¼Œå°±å¯ä»¥é€šè¿‡ * è¿ç®—ç¬¦è§£å¼•ç”¨è·å–è¿­ä»£å™¨æŒ‡å‘çš„å€¼ï¼š

```cpp
map<string, int> m = {
    {"fuck", 985},
};
auto it = m.find("fuck");  // å¯»æ‰¾ K ä¸º "fuck" çš„å…ƒç´ 
if (it != m.end()) {
    auto kv = *it;     // è§£å¼•ç”¨å¾—åˆ° K-V å¯¹
    print(kv);         // {"fuck", 985}
    print(kv.first);   // "fuck"
    print(kv.second);  // 985
} else {
    print("æ‰¾ä¸åˆ° fuckï¼");
}
```

---

æ£€æŸ¥è¿‡ä¸æ˜¯ m.end()ï¼Œä»¥ç¡®è®¤æˆåŠŸæ‰¾åˆ°åï¼Œå°±å¯ä»¥é€šè¿‡ * è¿ç®—ç¬¦è§£å¼•ç”¨è·å–è¿­ä»£å™¨æŒ‡å‘çš„å€¼ï¼š

```cpp
map<string, int> m = {
    {"fuck", 985},
};
auto it = m.find("fuck");  // å¯»æ‰¾ K ä¸º "fuck" çš„å…ƒç´ 
if (it != m.end()) {
    auto kv = *it;     // è§£å¼•ç”¨å¾—åˆ° K-V å¯¹
    print(kv);         // {"fuck", 985}
    print(kv.first);   // "fuck"
    print(kv.second);  // 985
} else {
    print("æ‰¾ä¸åˆ° fuckï¼");
}
```

---

æ³¨æ„ `*it` è§£å¼•ç”¨å¾—åˆ°çš„æ˜¯ K-V å¯¹ï¼Œéœ€è¦ `(*it).second` æ‰èƒ½è·å–å•ç‹¬çš„ Vã€‚

å¥½åœ¨ C è¯­è¨€å°±æœ‰ `->` è¿ç®—ç¬¦ä½œä¸ºè¯­æ³•ç³–ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å†™æˆ `it->second`ï¼Œä¸ `(*it).second` ç­‰ä»·ã€‚

```cpp
map<string, int> m = {
    {"fuck", 985},
};
auto it = m.find("fuck");   // å¯»æ‰¾ K ä¸º "fuck" çš„å…ƒç´ 
if (it != m.end()) {
    print(it->second);      // è¿­ä»£å™¨æœ‰æ•ˆï¼Œå¯ä»¥ç›´æ¥è·å¾—å€¼éƒ¨åˆ† 985
} else {
    print("æ‰¾ä¸åˆ° fuckï¼");  // è¿™ä¸ªåˆ†æ”¯é‡Œä¸å¾—ç”¨ * å’Œ -> è¿ç®—ç¬¦è§£å¼•ç”¨ it
}
```

å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬æŸ¥è¯¢åªéœ€è¦è·å–å€¼ V çš„éƒ¨åˆ†å°±è¡Œäº†ï¼Œç›´æ¥ `it->second` å°±å¯ä»¥äº†âœ…

> æ³¨æ„ï¼šfind æ‰¾ä¸åˆ°é”®æ—¶ï¼Œä¼šè¿”å› `m.end()`ï¼Œè¿™æ˜¯ä¸ªæ— æ•ˆè¿­ä»£å™¨ï¼Œåªä½œä¸ºæ ‡è¯†ç¬¦ä½¿ç”¨ï¼ˆç±»æ¯” Python ä¸­çš„ find æœ‰æ—¶ä¼šè¿”å› -1ï¼‰ã€‚
>
> æ²¡æœ‰ç¡®è®¤ `it != m.end()` å‰ï¼Œä¸å¯ä»¥è®¿é—® `it->second`ï¼é‚£ç›¸å½“äºè§£å¼•ç”¨ä¸€ä¸ªç©ºæŒ‡é’ˆï¼Œä¼šé€ æˆ segfaultï¼ˆæ›´ä¸“ä¸šä¸€ç‚¹è¯´æ˜¯ UBï¼‰ã€‚
>
> è®°ä½ï¼Œä¸€å®šè¦åœ¨ `it != m.end()` çš„åˆ†æ”¯é‡Œæ‰èƒ½è®¿é—® `it->second` å“¦ï¼ä½ å¾—å…ˆæ£€æŸ¥è¿‡é¥­ç¢—é‡Œæ²¡æœ‰è€é¼ ğŸ’©ä¹‹åï¼Œæ‰èƒ½å®‰å¿ƒåƒé¥­ï¼
>
> å¦‚æœä½ æƒ³è®©è€å¦ˆï¼ˆæ ‡å‡†åº“ï¼‰è‡ªåŠ¨å¸®ä½ æ£€æŸ¥æœ‰æ²¡æœ‰è€é¼ ğŸ’©ï¼Œé‚£å°±ç”¨ä¼šè‡ªåŠ¨æŠ¥é”™çš„ atï¼ˆç±»æ¯” Python ä¸­çš„ index æ‰¾ä¸åˆ°ç›´æ¥æŠ¥é”™ï¼‰ã€‚
>
> ä¹‹æ‰€ä»¥ç”¨ findï¼Œæ˜¯å› ä¸ºæœ‰æ—¶é¥­ç¢—é‡Œå‡ºè€é¼ ğŸ’©ï¼Œæ˜¯è®¡åˆ’çš„ä¸€éƒ¨åˆ†ï¼ä¾‹å¦‚å½“æœ‰è€é¼ ğŸ’©æ—¶ä½ å¯ä»¥æ”¹åƒåˆ«çš„é›¶é£Ÿã€‚è€Œ at è¿™ä¸ªè‰¯å¿ƒè€å¦ˆå‘¢ï¼Ÿä¸€å‘ç°è€é¼ ğŸ’©å°±æ‹–ç€ä½ å»è­¦å¯Ÿå±€æŠ¥æ¡ˆï¼Œé›¶é£Ÿï¼ˆé»˜è®¤å€¼ï¼‰ä¹Ÿä¸è®©ä½ åƒäº†ã€‚ä»Šæ—¥è¡Œç¨‹å…¨éƒ¨å–æ¶ˆï¼Œç»´æƒï¼ˆå¼‚å¸¸å¤„ç†ï¼Œæ‰¾ä¸Šå±‚ try-catch å—ï¼‰è®¾ä¸ºç¬¬ä¸€è¦åŠ¡ã€‚

---

å¸¦é»˜è®¤å€¼çš„æŸ¥è¯¢

ä¼—æ‰€å‘¨çŸ¥ï¼ŒPython ä¸­çš„ dict æœ‰ä¸€ä¸ª m.get(key, defl) çš„åŠŸèƒ½ï¼Œæ•ˆæœæ˜¯å½“ key ä¸å­˜åœ¨æ—¶ï¼Œè¿”å› defl è¿™ä¸ªé»˜è®¤å€¼ä»£æ›¿ m[key]ï¼Œè€Œ C++ çš„ map å´æ²¡æœ‰ï¼Œåªèƒ½ç”¨ä¸€å¥—ç»„åˆæ‹³ä»£æ›¿ï¼š

```cpp
m.count(key) ? m.at(key) : defl
```

ä½†ä¸Šé¢è¿™æ ·å†™æ˜¯æ¯”è¾ƒä½æ•ˆçš„ï¼Œç›¸å½“äºæŸ¥è¯¢äº† map ä¸¤éï¼Œat é‡Œè¿˜é¢å¤–åšäº†ä¸€æ¬¡å¤šä½™çš„å¼‚å¸¸åˆ¤æ–­ã€‚

æ­£å¸¸æ¥è¯´æ˜¯ç”¨é€šç”¨ find å»æ‰¾ï¼Œè¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼Œç„¶ååˆ¤æ–­æ˜¯ä¸æ˜¯ end() å†³å®šè¦ä¸è¦é‡‡ç”¨é»˜è®¤å€¼ã€‚

```cpp
auto it = m.find(key);
return it == m.end() ? it->second : defl;
```

> é¥­ç¢—é‡Œå‘ç°äº†è€é¼ ğŸ’©ï¼Ÿåˆ«æ€¥ç€æŠ¥è­¦ï¼Œè¿™ä¹Ÿåœ¨æˆ‘çš„é¢„æ–™ä¹‹ä¸­ï¼šå¯ç”¨ B è®¡åˆ’ï¼Œæ”¹åƒ defl è¿™æ¬¾ç¾å‘³é›¶é£Ÿå³å¯ï¼
>
> å¦‚æœæ˜¯è‰¯å¿ƒè€å¦ˆ atï¼Œå°±ç›´æ¥å¯ç”¨ C è®¡åˆ’ï¼š![Plan C](images/planc.png) æŠ›å‡ºå¼‚å¸¸ç„¶åå¥”æºƒäº†ï¼Œè™½ç„¶è¿™å¾ˆæ–¹ä¾¿æˆ‘ä»¬ç¨‹åºå‘˜è°ƒè¯•ã€‚

---

ç”±äºè‡ªå¸¦é»˜è®¤å€¼çš„æŸ¥è¯¢è¿™ä¸€åŠŸèƒ½å®åœ¨æ˜¯å¤ªå¸¸ç”¨äº†ï¼Œä¸ºäº†æŠŠè¿™ä¸ªæ“ä½œæµ“ç¼©åˆ°ä¸€è¡Œï¼Œæˆ‘å»ºè®®åŒå­¦ä»¬å°è£…æˆå‡½æ•°æ”¾åˆ°è‡ªå·±çš„é¡¹ç›®å…¬å…±å¤´æ–‡ä»¶ï¼ˆä¸€èˆ¬æ˜¯ utils.h ä¹‹ç±»çš„åç§°ï¼‰é‡Œæ–¹ä¾¿ä»¥åä½¿ç”¨ï¼š

```cpp
template <class M>
typename M::mapped_type map_get
( M const &m
, typename M::key_type const &key
, typename M::mapped_type const &defl
) {
  typename M::const_iterator it = m.find(key);
  if (it != m.end()) {
    return it->second;
  } else {
    return defl;
  }
}
```

```cpp
int val = map_get(config, "timeout", -1);  // å¦‚æœé…ç½®æ–‡ä»¶é‡Œä¸æŒ‡å®šï¼Œåˆ™é»˜è®¤ timeout ä¸º -1
```

---

è¿™æ ·è¿˜ä¸å¤Ÿä¼˜é›…ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ›´ä¼˜é›…åœ°è¿ç”¨ C++17 çš„å‡½æ•°å¼å®¹å™¨ optionalï¼š

```cpp
template <class M>
std::optional<typename M::mapped_type> map_get
( M const &m
, typename M::key_type const &key
) {
  typename M::const_iterator it = m.find(key);
  if (it != m.end()) {
    return it->second;
  } else {
    return std::nullopt;
  }
}
```

å½“æ‰¾ä¸åˆ°æ—¶å°±è¿”å› nulloptï¼Œæ‰¾åˆ°å°±è¿”å›å«æœ‰å€¼çš„ optionalã€‚

æ³¨ï¼šæœ¬æ®µä»£ç å·²é™„åœ¨æ¡ˆä¾‹ä»£ç åº“çš„ "map_get.h" æ–‡ä»¶ä¸­ï¼Œç­‰è¯¾åå¯ä»¥å» GitHub ä¸‹è½½ã€‚

---

è°ƒç”¨è€…å¯ä»¥è‡ªè¡Œè¿ç”¨ optional çš„ value_or å‡½æ•°[^1]æŒ‡å®šæ‰¾ä¸åˆ°æ—¶é‡‡ç”¨çš„é»˜è®¤å€¼ï¼š

```cpp
int val = map_get(config, "timeout").value_or(-1);
```

å¦‚æœè¦å®ç° at åŒæ ·çš„æ‰¾ä¸åˆ°å°±è‡ªåŠ¨æŠ¥é”™åŠŸèƒ½ï¼Œé‚£å°±æ”¹ç”¨ value å‡½æ•°ï¼š

```cpp
int val = map_get(config, "timeout").value();
```

ä»¥ä¸Šæ˜¯å…¸å‹çš„å‡½æ•°å¼ç¼–ç¨‹èŒƒå¼ (FP)ï¼ŒC++20 è¿˜å¼•å…¥äº†æ›´å¤šè¿™æ ·çš„ç©æ„[^2]ï¼Œç­‰æœ‰ç©ºä¼šä¸“é—¨å¼€èŠ‚è¯¾ä¸ºå¤§å®¶ä¸€ä¸€ä»‹ç»ã€‚

```cpp
auto even = [] (int i) { return 0 == i % 2; };
auto square = [] (int i) { return i * i; };
for (int i: std::views::iota(0, 6)
          | std::views::filter(even)
          | std::views::transform(square))
    print(i);  // 0 4 16
```

[^1]: https://en.cppreference.com/w/cpp/utility/optional/value_or
[^2]: https://en.cppreference.com/w/cpp/ranges/filter_view

---

map çš„æˆå‘˜ insert å‡½æ•°åŸå‹å¦‚ä¸‹[^1]ï¼š

```cpp
pair<iterator, bool> insert(pair<const K, V> const &kv);
pair<iterator, bool> insert(pair<const K, V> &&kv);
```

ä»–çš„å‚æ•°ç±»å‹å°±æ˜¯åˆšåˆšä»‹ç»çš„ `value_type`ï¼Œä¹Ÿå°±æ˜¯ `pair<const K, V>`ã€‚

pair æ˜¯ä¸€ä¸ª STL ä¸­å¸¸è§çš„æ¨¡æ¿ç±»å‹ï¼Œ`pair<K, V>` æœ‰ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼š

- firstï¼šV ç±»å‹ï¼Œè¡¨ç¤ºè¦æ’å…¥å…ƒç´ çš„é”®
- secondï¼šK ç±»å‹ï¼Œè¡¨ç¤ºè¦æ’å…¥å…ƒç´ çš„å€¼

æˆ‘ç§°ä¹‹ä¸º"é”®å€¼å¯¹"ã€‚

[^1]: https://en.cppreference.com/w/cpp/container/map/insert

---

è¯•ç€ç”¨ insert æ’å…¥é”®å€¼å¯¹ï¼š

```cpp
map<string, int> m;
pair<string, int> p;
p.first = "fuck";  // é”®
p.second = 985;    // å€¼
m.insert(p);  // pair<string, int> å¯ä»¥éšå¼è½¬æ¢ä¸º insert å‚æ•°æ‰€éœ€çš„ pair<const string, int>
print(m);
```

ç»“æœï¼š

```
{"fuck": 985}
```

---

ç®€åŒ– insert

<!-- <v-clicks> -->

1. ç›´æ¥ä½¿ç”¨ pair çš„æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ– first å’Œ second

```cpp
pair<string, int> p("fuck", 985);
m.insert(p);
```

2. ä¸ç”¨åˆ›å»ºä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œpair è¡¨è¾¾å¼ç›´æ¥ä½œä¸º insert å‡½æ•°çš„å‚æ•°

```cpp
m.insert(pair<string, int>("fuck", 985));
```

2. å¯ä»¥ç”¨ `std::make_pair` è¿™ä¸ªå‡½æ•°ï¼Œè‡ªåŠ¨å¸®ä½ æ¨å¯¼æ¨¡æ¿å‚æ•°ç±»å‹ï¼Œçœç•¥ `<string, int>`

```cpp
m.insert(make_pair("fuck", 985));  // è™½ç„¶ä¼šæ¨å¯¼ä¸º pair<const char *, int> ä½†è¿˜æ˜¯èƒ½éšå¼è½¬æ¢ä¸º pair<const string, int>
```

3. ç”±äº insert å‡½æ•°åŸå‹å·²çŸ¥å‚æ•°ç±»å‹ï¼Œå¯ä»¥ç›´æ¥ç”¨ C++11 çš„èŠ±æ‹¬å·åˆå§‹åŒ–åˆ—è¡¨ {...}ï¼Œæ— éœ€æŒ‡å®šç±»å‹

```cpp
m.insert({"fuck", 985});           // âœ…
```

<!-- </v-clicks> -->

---
layout: two-cols-header
---

å› æ­¤ï¼Œinsert çš„æœ€ä½³ç”¨æ³•æ˜¯ï¼š

```cpp
map<K, V> m;
m.insert({"key", "val"});
```

insert æ’å…¥å’Œ [] å†™å…¥çš„å¼‚åŒï¼š

- åŒï¼šå½“é”® K ä¸å­˜åœ¨æ—¶ï¼Œinsert å’Œ [] éƒ½ä¼šåˆ›å»ºé”®å€¼å¯¹ã€‚
- å¼‚ï¼šå½“é”® K å·²ç»å­˜åœ¨æ—¶ï¼Œinsert ä¸ä¼šè¦†ç›–ï¼Œé»˜é»˜ç¦»å¼€ï¼›è€Œ [] ä¼šè¦†ç›–æ—§çš„å€¼ã€‚

ä¾‹å­ï¼š

::left::

```cpp
map<string, string> m;
m.insert({"key", "old"});
m.insert({"key", "new"});  // æ’å…¥å¤±è´¥ï¼Œé»˜é»˜æ”¾å¼ƒä¸å‡ºé”™
print(m);
```

```
{"key": "old"}
```

::right::

```cpp
map<string, string> m;
m["key"] = "old";
m["key"] = "new";        // å·²ç»å­˜åœ¨ï¼Ÿæˆ‘è¸é©¬å¼ºè¡Œè¦†ç›–ï¼
print(m);
```

```
{"key": "new"}
```

---

insert çš„è¿”å›å€¼æ˜¯ `pair<iterator, bool>` ç±»å‹ï¼Œ<del>STL çš„å°¿æ€§ï¼šåœ¨éœ€è¦ä¸€æ¬¡æ€§è¿”å›ä¸¤ä¸ªå€¼æ—¶å–œæ¬¢ç”¨ pair</del>ã€‚

è¿™åˆæ˜¯ä¸€ä¸ª pair ç±»å‹ï¼Œå…¶å…·æœ‰ä¸¤ä¸ªæˆå‘˜ï¼š

- firstï¼šiterator ç±»å‹ï¼Œæ˜¯ä¸ªè¿­ä»£å™¨
- secondï¼šbool ç±»å‹ï¼Œè¡¨ç¤ºæ’å…¥æˆåŠŸä¸å¦ï¼Œå¦‚æœå‘ç”Ÿé”®å†²çªåˆ™ä¸º false

å…¶ä¸­ first è¿™ä¸ªè¿­ä»£å™¨æŒ‡å‘çš„æ˜¯ï¼š

- å¦‚æœæ’å…¥æˆåŠŸï¼ˆsecond ä¸º trueï¼‰ï¼ŒæŒ‡å‘åˆšåˆšæˆåŠŸæ’å…¥çš„å…ƒç´ ä½ç½®
- å¦‚æœæ’å…¥å¤±è´¥ï¼ˆsecond ä¸º falseï¼‰ï¼Œè¯´æ˜å·²ç»æœ‰ç›¸åŒçš„é”® K å­˜åœ¨ï¼Œå‘ç”Ÿäº†é”®å†²çªï¼ŒæŒ‡å‘å·²ç»å­˜åœ¨çš„é‚£ä¸ªå…ƒç´ 

---

å…¶å® insert è¿”å›çš„ first è¿­ä»£å™¨ç­‰ä»·äºæ’å…¥ä»¥åå†é‡æ–°ç”¨ find æ‰¾åˆ°åˆšåˆšæ’å…¥çš„é‚£ä¸ªé”®ï¼Œåªæ˜¯æ•ˆç‡æ›´é«˜ï¼š

```cpp
auto it = m.insert({k, v}).first;  // é«˜æ•ˆï¼Œåªéœ€éå†ä¸€æ¬¡
```

```cpp
m.insert({k, v});     // æ’å…¥å®Œå°±å¿˜äº‹äº†
auto it = m.find(k);  // é‡æ–°éå†ç¬¬äºŒæ¬¡ï¼Œä½†ç»“æœä¸€æ ·
```

å‚è€ƒ C ç¼–ç¨‹ç½‘[^1]å¯¹ insert è¿”å›å€¼çš„è§£é‡Šï¼š

> å½“è¯¥æ–¹æ³•å°†æ–°é”®å€¼å¯¹æˆåŠŸæ·»åŠ åˆ°å®¹å™¨ä¸­æ—¶ï¼Œè¿”å›çš„è¿­ä»£å™¨æŒ‡å‘æ–°æ·»åŠ çš„é”®å€¼å¯¹ï¼›
>
> åä¹‹ï¼Œå¦‚æœæ·»åŠ å¤±è´¥ï¼Œè¯¥è¿­ä»£å™¨æŒ‡å‘çš„æ˜¯å®¹å™¨ä¸­å’Œè¦æ·»åŠ é”®å€¼å¯¹é”®ç›¸åŒçš„é‚£ä¸ªé”®å€¼å¯¹ã€‚

[^1]: http://c.biancheng.net/view/7241.html

---

å¯ä»¥ç”¨ insert è¿”å›çš„ second åˆ¤æ–­æ’å…¥å¤šæ¬¡æ˜¯å¦æˆåŠŸï¼š

```cpp
map<string, string> m;
print(m.insert({"key", "old"}).second);  // true
print(m.insert({"key", "new"}).second);  // false
m.erase("key");     // æŠŠåŸæ¥çš„ {"key", "old"} åˆ äº†
print(m.insert({"key", "new"}).second);  // true
```

ä¹Ÿå¯ä»¥ç”¨ structual-binding è¯­æ³•æ‹†è§£ä»–è¿”å›çš„ `pair<iterator, bool>`ï¼š

```cpp
map<string, int> counter;
auto [it, success] = counter.insert("key", 1);  // ç›´æ¥ç”¨
if (!success) {  // å¦‚æœå·²ç»å­˜åœ¨ï¼Œåˆ™ä¿®æ”¹å…¶å€¼+1
    it->second = it->second + 1;
} else {  // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ‰“å°ä»¥ä¸‹ä¿¡æ¯
    print("created a new entry!");
}
```

ä»¥ä¸Šè¿™ä¸€é•¿ä¸²ä»£ç å’Œä¹‹å‰â€œä¼˜é›…â€çš„è®¡æ•° [] ç­‰ä»·ï¼š

```cpp
counter["key"]++;
```

---

åœ¨ C++17 ä¸­ï¼Œ[] å†™å…¥æœ‰äº†ä¸ªæ›´é«˜æ•ˆçš„æ›¿ä»£å“ insert_or_assign[^1]ï¼š

```cpp
pair<iterator, bool> insert_or_assign(K const &k, V v);
pair<iterator, bool> insert_or_assign(K &&k, V v);
```

æ­£å¦‚ä»–åå­—çš„å«ä¹‰ï¼Œâ€œæ’å…¥æˆ–è€…å†™å…¥â€ï¼š

- å¦‚æœ K ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼ˆæ’å…¥ï¼‰
- å¦‚æœ K å·²ç»å­˜åœ¨åˆ™è¦†ç›–ï¼ˆå†™å…¥ï¼‰

ç”¨æ³•å¦‚ä¸‹ï¼š

```cpp
m.insert_or_assign("key", "new");  // ä¸ insert ä¸åŒï¼Œä»–ä¸éœ€è¦ {...}ï¼Œä»–çš„å‚æ•°å°±æ˜¯ä¸¤ä¸ªå•ç‹¬çš„ K å’Œ V
```

è¿”å›å€¼ä¾æ—§æ˜¯ `pair<iterator, bool>`ã€‚ç”±äºè¿™å‡½æ•°åœ¨é”®å†²çªæ—¶ä¼šè¦†ç›–ï¼ŒæŒ‰ç†è¯´æ˜¯å¿…å®šæˆåŠŸäº†ï¼Œå› æ­¤è¿™ä¸ª bool çš„å«ä¹‰ä»â€œæ˜¯å¦æ’å…¥æˆåŠŸâ€å˜ä¸ºâ€œæ˜¯å¦åˆ›å»ºäº†å…ƒç´ â€ï¼Œå¦‚æœæ˜¯åˆ›å»ºçš„æ–°å…ƒç´ è¿”å›trueï¼Œå¦‚æœè¦†ç›–äº†æ—§å…ƒç´ è¿”å›falseã€‚

[^1]: https://en.cppreference.com/w/cpp/container/map/insert_or_assign

---

çœ‹æ¥ insert_or_assign å’Œ [] çš„æ•ˆæœå®Œå…¨ç›¸åŒï¼éƒ½æ˜¯åœ¨é”®å€¼å†²çªæ—¶è¦†ç›–æ—§å€¼ã€‚

æ—¢ç„¶ [] å·²ç»å¯ä»¥åšåˆ°åŒæ ·çš„æ•ˆæœï¼Œä¸ºä»€ä¹ˆè¿˜è¦å‘æ˜ä¸ª insert_or_assign å‘¢ï¼Ÿ

insert_or_assign çš„ä¼˜ç‚¹æ˜¯**ä¸éœ€è¦è°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°**ï¼Œå¯ä»¥æå‡æ€§èƒ½ã€‚

å…¶åº”ç”¨åœºæ™¯æœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š

- â± æ‚¨ç‰¹åˆ«åœ¨ä¹æ€§èƒ½
- âŒ æœ‰æ—¶ V ç±»å‹æ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°ï¼Œç”¨ [] ç¼–è¯‘å™¨ä¼šæŠ¥é”™
- ğŸ¥µ å¼ºè¿«ç—‡å‘ä½œ

å¦åˆ™ç”¨ [] å†™å…¥ä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ã€‚

insert_or_assign èƒ½å–ä»£ [] çš„å²—ä½ä»…é™äºçº¯å†™å…¥ï¼Œä¹‹å‰ `counter[key]++` è¿™ç§â€œä¼˜é›…â€å†™æ³•ä¾ç„¶æ˜¯éœ€è¦ç”¨ [] çš„ã€‚

---
layout: two-cols-header
---

åˆ›å»ºæ–°é”®æ—¶ï¼Œinsert_or_assign æ›´é«˜æ•ˆã€‚

::left::

```cpp
map<string, string> m;
m["key"] = "old";
m["key"] = "new";
print(m);
```

```
{"key": "new"}
```

è¦†ç›–æ—§é”®æ—¶ï¼Œä½¿ç”¨ [] é€ æˆçš„å¼€é”€ï¼š

- è°ƒç”¨ç§»åŠ¨èµ‹å€¼å‡½æ•° `V &operator=(V &&)`

åˆ›å»ºæ–°é”®æ—¶ï¼Œä½¿ç”¨ [] é€ æˆçš„å¼€é”€ï¼š

- è°ƒç”¨é»˜è®¤æ„é€ å‡½æ•° `V()`
- è°ƒç”¨ç§»åŠ¨èµ‹å€¼å‡½æ•° `V &operator=(V &&)`

::right::

```cpp
map<string, string> m;
m.insert_or_assign("key", "old");
m.insert_or_assign("key", "new");
print(m);
```

```
{"key": "new"}
```

è¦†ç›–æ—§é”®æ—¶ï¼Œä½¿ç”¨ insert_or_assign é€ æˆçš„å¼€é”€ï¼š

- è°ƒç”¨ç§»åŠ¨èµ‹å€¼å‡½æ•° `V &operator=(V &&)`

åˆ›å»ºæ–°é”®æ—¶ï¼Œä½¿ç”¨ insert_or_assign é€ æˆçš„å¼€é”€ï¼š

- è°ƒç”¨ç§»åŠ¨æ„é€ å‡½æ•° `V(V &&)`

---

å¦‚æœä½ æœ‰æ€§èƒ½å¼ºè¿«ç—‡ï¼Œå¹¶ä¸”æ˜¯ C++17 æ ‡å‡†ï¼š

- å†™å…¥ç”¨ insert_or_assign
- è¯»å–ç”¨ at

å¦‚æœæ²¡æœ‰æ€§èƒ½å¼ºè¿«ç—‡ï¼Œæˆ–è€…ä½ çš„ç¼–è¯‘å™¨ä¸æ”¯æŒ C++17 æ ‡å‡†ï¼š

- å†™å…¥ç”¨ []
- è¯»å–ç”¨ at

æœ€åï¼Œå¦‚æœä½ æ˜¯è¿˜åŸè®ºè€…ï¼Œåªéœ€è¦ find å’Œ insert å‡½æ•°å°±æ˜¯å®Œå¤‡çš„äº†ï¼Œåˆ«çš„å‡½æ•°éƒ½ä¸ç”¨å»è®°ã€‚æ‰€æœ‰ atã€[]ã€insert_or_assign ä¹‹ç±»çš„æ“ä½œéƒ½å¯ä»¥é€šè¿‡ find å’Œ insert çš„ç»„åˆæ‹³å®ç°ï¼Œä¾‹å¦‚åˆšåˆšæˆ‘ä»¬è‡ªå®šä¹‰çš„ map_getã€‚

---

é™¤äº†åˆšåˆšä»‹ç»çš„ `insert(pair<K, V>)` å¤–ï¼Œinsert è¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ç‰ˆæœ¬ï¼Œç”¨äºæ‰¹é‡æ’å…¥ä¸€ç³»åˆ—å…ƒç´ ã€‚

```cpp
template <class InputIt>
void insert(InputIt beg, InputIt end);
```

å‚æ•°[^1]æ˜¯ä¸¤ä¸ªè¿­ä»£å™¨ beg å’Œ endï¼Œç»„æˆä¸€ä¸ªåŒºé—´ï¼Œä¹‹é—´æ˜¯ä½ è¦æ’å…¥çš„æ•°æ®ã€‚

è¯¥åŒºé—´å¯ä»¥æ˜¯ä»»ä½•å…¶ä»–å®¹å™¨çš„ begin() å’Œ end() è¿­ä»£å™¨â€”â€”é‚£ä¼šæŠŠè¯¥å®¹å™¨ä¸­æ‰€æœ‰çš„å…ƒç´ éƒ½æ’å…¥åˆ°æœ¬ map ä¸­å»ã€‚

ç”¨æ³•ä¸¾ä¾‹ï¼šæŠŠ vector ä¸­çš„é”®å€¼å¯¹æ‰¹é‡æ’å…¥ mapï¼š

```cpp
vector<pair<string, int>> kvs = {
    {"timeout", 985},
    {"delay", 211},
};
map<string, int> config;
config.insert(kvs.begin(), kvs.end());
print(config);  // {"delay": 211, "timeout": 985}
```

[^1]: è½¶äº‹ï¼šåœ¨æ ‡å‡†åº“æ–‡æ¡£é‡Œæ‰¹é‡æ’å…¥ç‰ˆ insert å‡½æ•°çš„ beg å’Œ end è¿™ä¸¤ä¸ªå‚æ•°åä¸º first å’Œ lastï¼Œä½†ä¸ pair çš„ first å¹¶æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œåªæ˜¯ä¸ºäº†é˜²æ­¢å˜é‡åå’Œ begin() å’Œ end() æˆå‘˜å‡½æ•°å‘ç”Ÿå‘½åå†²çªã€‚ä¸ºäº†é˜²æ­¢åŒå­¦ä»¬ä¸ pair çš„ first æ··æ·†æ‰€ä»¥æ‰æ”¹æˆ beg å’Œ end åšå‚æ•°åã€‚

---

C++11 è¿˜å¼•å…¥äº†ä¸€ä¸ªä»¥åˆå§‹åŒ–åˆ—è¡¨ï¼ˆinitializer_listï¼‰ä¸ºå‚æ•°çš„ç‰ˆæœ¬ï¼š

```cpp
void insert(initializer_list<pair<K, V>> ilist);
```

ç”¨æ³•å’Œ map çš„æ„é€ å‡½æ•°ä¸€æ ·ï¼Œè¿˜æ˜¯ç”¨èŠ±æ‹¬å·åˆ—è¡¨ï¼š

```cpp
map<string, int> m = {  // åˆå§‹åŒ–æ—¶å°±æ’å…¥ä¸¤ä¸ªå…ƒç´ 
    {"answer", 42},
    {"timeout", 7},
};
m.insert({              // æ‰¹é‡å†æ’å…¥ä¸¤ä¸ªæ–°å…ƒç´ 
    {"timeout", 985},   // "timeout" å‘ç”Ÿé”®å†²çªï¼Œæ ¹æ® insert çš„å°¿æ€§ï¼Œä¸ä¼šè¦†ç›–
    {"delay", 211},
});
```

```
{"answer": 42, "delay": 211, "timeout": 7}
```

æ³¨æ„çœ‹è¿™é‡Œè¿˜æ˜¯å’Œ insert({k, v}) ä¸€æ ·çš„å°¿æ€§ï¼Œé‡å¤çš„é”® "timeout" æ²¡æœ‰è¢«è¦†ç›–ï¼Œä¾æ—§äº†ä¿ç•™åŸå€¼ã€‚

---

å°å½­è€å¸ˆé”è¯„æ‰¹é‡ insert

```cpp
m.insert({
    {"timeout", 985},
    {"delay", 211},
});
```

æ€»ä¹‹è¿™ç©æ„å’Œåˆ†åˆ«è°ƒç”¨ä¸¤æ¬¡ insert ç­‰ä»·ï¼Œä¹Ÿå¹¶ä¸é«˜æ•ˆå¤šå°‘ï¼š

```cpp
m.insert({"timeout", 985});
m.insert({"delay", 211});
```

å¦‚æœéœ€è¦è¦†ç›–åŸå€¼çš„æ‰¹é‡æ’å…¥ï¼Œè¿˜æ˜¯ä¹–ä¹–ç”¨ for å¾ªç¯è°ƒç”¨ [] æˆ– insert_or_assign å§ã€‚


---

```cpp
iterator insert(const_iterator pos, pair<K, V> const &kv);
```

è¿™åˆæ˜¯ insert å‡½æ•°çš„ä¸€ä¸ªé‡è½½ç‰ˆï¼Œå¢åŠ äº† pos å‚æ•°æç¤ºæ’å…¥ä½ç½®ï¼Œæˆ‘çš„è¯„ä»·æ˜¯[æ„ä¹‰ä¸æ˜çš„å­˜åœ¨](https://www.bilibili.com/video/av9609348?p=1)ï¼Œå®˜æ–¹æ–‡æ¡£ç§°[^1]ï¼š

> Inserts value in the position as close as possible to the position just prior to pos.
>
> æŠŠå…ƒç´ ï¼ˆé”®å€¼å¯¹ï¼‰æ’å…¥åˆ°ä½äº pos ä¹‹å‰ï¼Œåˆç¦» pos å°½å¯èƒ½è¿‘çš„åœ°æ–¹ã€‚

ç„¶è€Œ map ä½œä¸ºçº¢é»‘æ ‘åº”è¯¥å§‹ç»ˆä¿æŒæœ‰åºï¼Œæ’å…¥ä½ç½®å¯ä»¥ç”± K å”¯ä¸€ç¡®å®šï¼Œä¸ºå•¥è¿˜è¦æç¤ºï¼ŸC ç¼–ç¨‹ç½‘çš„è¯´æ³•æ˜¯[^2]ï¼š

> ï¼ˆå¸¦æç¤ºçš„ insert ç‰ˆæœ¬ï¼‰ä¸­ä¼ å…¥çš„è¿­ä»£å™¨ï¼Œä»…æ˜¯ç»™ map å®¹å™¨æä¾›ä¸€ä¸ªå»ºè®®ï¼Œå¹¶ä¸ä¸€å®šä¼šè¢«å®¹å™¨é‡‡çº³ã€‚è¯¥è¿­ä»£å™¨è¡¨æ˜å°†æ–°é”®å€¼å¯¹æ·»åŠ åˆ°å®¹å™¨ä¸­çš„ä½ç½®ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ–°é”®å€¼å¯¹æ·»åŠ åˆ°å®¹å™¨ä¸­çš„ä½ç½®ï¼Œå¹¶ä¸æ˜¯æ­¤è¿­ä»£å™¨è¯´äº†ç®—ï¼Œæœ€ç»ˆä»å–å†³äºè¯¥é”®å€¼å¯¹çš„é”®çš„å€¼ã€‚

ä¹Ÿå°±æ˜¯è¯´è¿™ç©æ„è¿˜ä¸ä¸€å®šç®¡ç”¨ï¼Œåªæ˜¯æç¤ºæ€§è´¨çš„ï¼ˆå’Œ mmap å‡½æ•°çš„ start å‚æ•°å¾ˆåƒï¼Œä½ å¯ä»¥æŒ‡å®šï¼Œä½†åªæ˜¯ä¸ªæç¤ºï¼ŒæŒ‡å®šäº†ä¸ä¸€å®šæœ‰ä»€ä¹ˆè½¯ç”¨ï¼Œå…·ä½“ä»€ä¹ˆåœ°å€è¿˜æ˜¯æ“ä½œç³»ç»Ÿè¯´äº†ç®—ï¼Œä»–ä»è¿”å›å€¼é‡Œç»™ä½ çš„åœ°å€æ‰æ˜¯æ­£ç¡®ç­”æ¡ˆï¼‰ã€‚

ä¼°è®¡åˆæ˜¯æ€§èƒ½å¼ºè¿«ç—‡å‘ä½œäº†å§ï¼Œä¾‹å¦‚å·²çŸ¥æŒ‡å‘ "key" çš„è¿­ä»£å™¨ï¼Œæƒ³è¦æ’å…¥ "kea"ï¼Œé‚£ä¹ˆæŒ‡å®šæŒ‡å‘ "key" çš„è¿­ä»£å™¨å°±ä¼šè®© find èƒ½æ›´å®¹æ˜“å®šä½åˆ° "kea" è¦æ’å…¥çš„ä½ç½®ï¼Ÿå¦‚æœä½ çŸ¥é“å‡†ç¡®åŸå› ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºæŒ‡å‡ºã€‚

[^1]: https://en.cppreference.com/w/cpp/container/map/insert
[^2]: http://c.biancheng.net/view/7241.html

---

insert çš„ç©¶æåˆ†å¥´ç‰ˆï¼šemplace

insert çš„å®‡å®™æ— æ•Œåˆ†å¥´ç‰ˆï¼šemplace_hint

insert çš„æ‰˜é©¬æ–¯é»„é‡‘å¤§å›æ—‹åˆ†å¥´ç‰ˆï¼štry_emplace

insert çš„ç‚«å½©ä¸­äºŒæ‘‡æ‘†æ··æ²Œå¤§é­”ç‹åˆ†å¥´ç‰ˆï¼šå¸¦æ’å…¥ä½ç½®æç¤ºçš„ try_emplace

---

find å’Œ insert éƒ½å­¦å®Œäº†ï¼Œæœ€åï¼Œè®©æˆ‘ä»¬æ¥å­¦ä¹ åˆ é™¤å…ƒç´ ç”¨çš„ erase å‡½æ•°ï¼Œå…¶åŸå‹å¦‚ä¸‹[^1]ï¼š

```cpp
iterator erase(K const &key);
iterator erase(iterator pos);
iterator erase(iterator beg, iterator end);
```

[^1]: https://en.cppreference.com/w/cpp/container/map/erase

---

erase è¿ç”¨ä¸¾ä¾‹ï¼šåˆ é™¤ä¸€ä¸ªå…ƒç´ 

```cpp
map<string, string> msg = {
    {"hello", "world"},
    {"fuck", "rust"},
};
print(msg);
msg.erase("fuck");
print(msg);
```

```
{"fuck": "rust", "hello": "world"}
{"hello": "world"}
```

---

# å¢åˆ 

| å†™æ³• | æ•ˆæœ | ç‰ˆæœ¬ | æ¨è |
|------|------|------|------|
| `m.insert(make_pair(key, val))` | æ’å…¥ä½†ä¸è¦†ç›– | C++98 | ğŸ’© |
| `m.insert({key, val})` | æ’å…¥ä½†ä¸è¦†ç›– | C++11 | â¤ |
| `m.emplace(key, val)` | æ’å…¥ä½†ä¸è¦†ç›– | C++11 | ğŸ’© |
| `m.try_emplace(key, valcons...)` | æ’å…¥ä½†ä¸è¦†ç›– | C++17 | ğŸ’£ |
| `m.insert_or_assign(key, val)` | æ’å…¥æˆ–è¦†ç›– | C++17 | â¤ |
| `m[key] = val` | æ’å…¥æˆ–è¦†ç›– | C++98 | ğŸ’£ |
| `m.erase(key)` | åˆ é™¤æŒ‡å®šå…ƒç´  | C++98 | â¤ |

---

# æ”¹æŸ¥

| å†™æ³• | æ•ˆæœ | ç‰ˆæœ¬ | æ¨è |
|------|------|------|------|
| `m.at(key)` | æ‰¾ä¸åˆ°åˆ™å‡ºé”™ï¼Œæ‰¾åˆ°åˆ™è¿”å›å¼•ç”¨ | C++98 | â¤ |
| `m[key]` | æ‰¾ä¸åˆ°åˆ™è‡ªåŠ¨åˆ›å»º`0`å€¼ï¼Œè¿”å›å¼•ç”¨ | C++98 | ğŸ’£ |
| `myutils::map_get(m, key, defl)` | æ‰¾ä¸åˆ°åˆ™è¿”å›é»˜è®¤å€¼ | C++98 | â¤ |
| `m.find(key) == m.end()` | æ£€æŸ¥é”® `key` æ˜¯å¦å­˜åœ¨ | C++98 | ğŸ’£ |
| `m.count(key)` | æ£€æŸ¥é”® `key` æ˜¯å¦å­˜åœ¨ | C++98 | â¤ |
| `m.contains(key)` | æ£€æŸ¥é”® `key` æ˜¯å¦å­˜åœ¨ | C++20 | ğŸ’© |

---

# åˆå§‹åŒ–

| å†™æ³• | æ•ˆæœ | ç‰ˆæœ¬ | æ¨è |
|------|------|------|------|
| `map<K, V> m = {{k1, v1}, {k2, v2}}` | åˆå§‹åŒ–ä¸ºä¸€ç³»åˆ—é”®å€¼å¯¹ | C++11 | â¤ |
| `auto m = map<K, V>{{k1, v1}, {k2, v2}}` | åˆå§‹åŒ–ä¸ºä¸€ç³»åˆ—é”®å€¼å¯¹ | C++11 | ğŸ’© |
| `func({{k1, v1}, {k2, v2}})` | ç»™å‡½æ•°å‚æ•°ä¼ å…¥ä¸€ä¸ª map | C++11 | â¤ |
| `m = {{k1, v1}, {k2, v2}}` | é‡ç½®ä¸ºä¸€ç³»åˆ—é”®å€¼å¯¹ | C++11 | â¤ |
| `m.assign({{k1, v1}, {k2, v2}})` | é‡ç½®ä¸ºä¸€ç³»åˆ—é”®å€¼å¯¹ | C++11 | ğŸ’© |
| `m.clear()` | æ¸…ç©ºæ‰€æœ‰è¡¨é¡¹ | C++98 | â¤ |
| `m = {}` | æ¸…ç©ºæ‰€æœ‰è¡¨é¡¹ | C++11 | ğŸ’£ |

---

map çš„è¿­ä»£å™¨å¤±æ•ˆé—®é¢˜

---

ä¸€è¾¹éå†ä¸€è¾¹åˆ é™¤éƒ¨åˆ†å…ƒç´ ï¼ˆé”™è¯¯ç¤ºèŒƒï¼‰

```cpp
map<string, string> msg = {
    {"hello", "world"},
    {"fucker", "rust"},
    {"fucking", "java"},
    {"good", "job"},
};
for (auto const &[k, v]: msg) {
    if (k.find("fuck") == 0) {
        msg.erase(k);  // éå†è¿‡ç¨‹ä¸­åŠ¨æ€åˆ é™¤å…ƒç´ ï¼Œä¼šå¯¼è‡´æ­£åœ¨éå†ä¸­çš„è¿­ä»£å™¨å¤±æ•ˆï¼Œå¥”æºƒ
    }
}
print(msg);
```

```
Segmentation fault (core dumped)
```

---

ä¸€è¾¹éå†ä¸€è¾¹åˆ é™¤éƒ¨åˆ†å…ƒç´ ï¼ˆæ­£è§£[^1]ï¼‰

```cpp
map<string, string> msg = {
    {"hello", "world"},
    {"fucker", "rust"},
    {"fucking", "java"},
    {"good", "job"},
};
for (auto it = m.begin(); it != m.end(); ) {  // æ²¡æœ‰ ++it
    auto const &[k, v] = *it;
    if (k.find("fuck") == 0) {
        it = msg.erase(it);
    } else {
        ++it;
    }
}
print(msg);
```

```
{"good": "job", "hello": "world"}
```

[^1]: https://stackoverflow.com/questions/8234779/how-to-remove-from-a-map-while-iterating-it

---

æ‰¹é‡åˆ é™¤ç¬¦åˆæ¡ä»¶çš„å…ƒç´ ï¼ˆC++20[^1]ï¼‰

```cpp
map<string, string> msg = {
    {"hello", "world"},
    {"fucker", "rust"},
    {"fucking", "java"},
    {"good", "job"},
};
std::erase_if(msg, [&] (auto const &kv) {
    auto &[k, v] = kv;
    return k.starts_with("fuck");
});
print(msg);
```

```
{"good": "job", "hello": "world"}
```

[^1]: https://www.apiref.com/cpp-zh/cpp/container/map/erase_if.html
